<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:db="http://www.mulesoft.org/schema/mule/db" xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd">
	<sub-flow name="client-db-wms-get-availability" doc:id="8cf9afc6-58b3-49d5-9ae7-8f8d694bb829" >
		<db:select doc:name="Select" doc:id="efda0571-bb4f-4dc0-becb-413ac6981664" config-ref="Database_Config_WMS_BlueYonder">
			<db:sql ><![CDATA[#[vars.queryAvailability]]]></db:sql>
		</db:select>
	</sub-flow>
	<sub-flow name="client-db-wms-get-volumetry" doc:id="668624cb-11e6-4fec-82c9-18369b7a2669" >
		<db:select doc:name="Select" doc:id="529895af-3d19-4897-b0bc-6f2a588a1af7" config-ref="Database_Config_WMS_BlueYonder">
			<db:sql ><![CDATA[#[vars.queryVolumetry]]]></db:sql>
		</db:select>
	</sub-flow>
	<sub-flow name="client-db-wms-get-partfoot-details" doc:id="c504be1d-524e-4928-a87a-9dcb543e8e4b" >
		<db:select doc:name="Select" doc:id="a2d5ad18-aaf6-40ec-b465-db5324a006a9" config-ref="Database_Config_WMS_BlueYonder">
			<db:sql ><![CDATA[select shipment.ship_id,
        prtmst.prtnum,
        trlr.dispatch_dte fecha_despacho,
        ord.stcust umu_idestacion,
        stop.stop_id tipoestacion_parada,
        adrmst.adrln1 calle,
        (select lngdsc
         from TRXWMSPRD.dscmst
         where colnam = 'adrstc'
			AND locale_id = 'ES-ES'
            AND colval = 'MEX|' || adrmst.adrstc) estado,
        adrmst.ctry_name pais,
        (select sum(aiv_2.untqty)
         from TRXWMSPRD.all_inventory_view aiv_2
         where aiv_2.subnum = all_inventory_view.subnum) total_mercancias,
        (select lngdsc
         from TRXWMSPRD.dscmst
         where colnam = 'ctncod|wh_id'
			and locale_id = 'ES-ES'
            and colval = pckwrk_view.ctncod || '|' || ord.wh_id) unidad_peso,
        altprt_sat.alt_prtnum clavesat,
        prtdsc.lngdsc descripcion,
        all_inventory_view.untqty cantidades,
        decode(prtmst.hazmat_flg, 0, 'NO', 'SI') peligroso,
        prtmst.ltlcls clave_peligroso,
        prtftp_dtl.grswgt * all_inventory_view.untqty pesoxarticulo,
        adrmst_car.adr_district permiso_transporte,
        trlr.trlr_seal2 aseguradora,
        trlr.trlr_seal3 poliza,
        trlr.trlr_typ tipo_vehiculo,
        trlr.trlr_ref placa,
        trlr.trlr_seal4 modelo,
        powerunit.powerunit_type tipo_remolque,
        powerunit.powerunit_id placa_remolque,
        trlr.trlr_broker rfc_operador,
        trlr.driver_nam nombre_operador,
        trlr.driver_lic_num lic_operador,
        carhdr.accnum rfc_transp,
        carhdr.carnam nombre_transp,
        adrmst_car.adrln1 calle_transp,
        adrmst_car.adrstc estado_transp,
        adrmst_car.adrcty pais_transp,
        adrmst_car.adrpsz cp_transp,
        ord.entdte fecha_levantamiento,
        prtmst.comcod partida_presupuestal,
		shipment_line.pckgr1 monto
from TRXWMSPRD.ord
	join TRXWMSPRD.ord_line
    on ord.ordnum = ord_line.ordnum
		and ord.wh_id = ord_line.wh_id
		and ord.client_id = ord_line.client_id
	join TRXWMSPRD.adrmst
	on adrmst.client_id = ord.client_id
		and adrmst.host_ext_id = ord.stcust
		and adrmst.adrtyp = 'CST'
    join TRXWMSPRD.shipment_line
    on shipment_line.ordnum = ord_line.ordnum
		and shipment_line.ordlin = ord_line.ordlin
		and shipment_line.wh_id = ord_line.wh_id
		and shipment_line.client_id = ord_line.client_id
		and shipment_line.linsts <> 'B'
    join TRXWMSPRD.all_inventory_view
    on all_inventory_view.wh_id = shipment_line.wh_id
		and all_inventory_view.prt_client_id = shipment_line.prt_client_id
		and all_inventory_view.ship_line_id = shipment_line.ship_line_id
	left join TRXWMSPRD.prtmst
	on all_inventory_view.prtnum = prtmst.prtnum
		and all_inventory_view.prt_client_id = prtmst.prt_client_id
		and prtmst.wh_id_tmpl = 'AVIOR-27'
	left join TRXWMSPRD.prtdsc
	on prtdsc.colnam = 'prtnum|prt_client_id|wh_id_tmpl'
		and prtdsc.colval = all_inventory_view.prtnum || '|' || all_inventory_view.prt_client_id || '|' || all_inventory_view.wh_id
	left join TRXWMSPRD.alt_prtmst altprt_sat
	on all_inventory_view.prtnum = altprt_sat.prtnum
		and all_inventory_view.prt_client_id = altprt_sat.prt_client_id
		and altprt_sat.alt_prt_typ = 'SAT'
        /* Huella pieza */
	left join TRXWMSPRD.prtftp_dtl
	on all_inventory_view.wh_id = prtftp_dtl.wh_id
		and all_inventory_view.prtnum = prtftp_dtl.prtnum
		and all_inventory_view.ftpcod = prtftp_dtl.ftpcod
		and prtftp_dtl.uomlvl = 0
	join TRXWMSPRD.shipment
	on shipment.ship_id = shipment_line.ship_id
		and shipment.wh_id = shipment_line.wh_id
		and shipment.shpsts <> 'B'
	join TRXWMSPRD.stop
    on shipment.stop_id = stop.stop_id
	join TRXWMSPRD.car_move
    on stop.car_move_id = car_move.car_move_id
	join TRXWMSPRD.trlr
    on car_move.trlr_id = trlr.trlr_id
		and trlr.trlr_cod = 'SHIP'
	left join TRXWMSPRD.pckwrk_view
	on pckwrk_view.client_id = shipment_line.client_id
		and pckwrk_view.wh_id = shipment_line.wh_id
		and pckwrk_view.ship_id = shipment_line.ship_id
		and pckwrk_view.ordnum = shipment_line.ordnum
		and pckwrk_view.prtnum = 'KITPART'
	left join TRXWMSPRD.carhdr
	on car_move.carcod = carhdr.carcod
	left join TRXWMSPRD.adrmst adrmst_car
    on carhdr.adr_id = adrmst_car.adr_id
	left join TRXWMSPRD.powerunit
	on car_move.carcod = powerunit.carcod
	AND trlr.powerunit_id = powerunit.powerunit_id
where ord.wh_id = 'AVIOR-27'
	and all_inventory_view.stoloc = trlr.trlr_id
	AND shipment.ship_id = :shipment
group by ord.ordnum,
        prtmst.prtnum,
        shipment.ship_id,
        trlr.dispatch_dte,
        ord.stcust,
        stop.stop_id,
        adrmst.adrln1,
        adrmst.adrstc,
        adrmst.ctry_name,
        pckwrk_view.ctncod,
        ord.wh_id,
        altprt_sat.alt_prtnum,
        all_inventory_view.untqty,
        all_inventory_view.subnum,
        prtdsc.lngdsc,
        prtmst.hazmat_flg,
        prtmst.ltlcls,
        prtftp_dtl.grswgt,
        adrmst_car.adr_district,
        trlr.trlr_seal2,
        trlr.trlr_seal3,
        trlr.trlr_seal4,
        trlr.trlr_typ,
        trlr.trlr_ref,
        powerunit.powerunit_type,
        powerunit.powerunit_id,
        trlr.trlr_broker,
        trlr.driver_lic_num,
        trlr.driver_nam,
        carhdr.accnum,
        carhdr.carnam,
        adrmst_car.adrln1,
        adrmst_car.adrcty,
        adrmst_car.adrstc,
        adrmst_car.adrpsz,
        prtmst.comcod,
        ord.entdte,
        shipment_line.pckgr1]]></db:sql>
			<db:input-parameters ><![CDATA[#[shipment:payload]]]></db:input-parameters>
		</db:select>
	</sub-flow>
	<sub-flow name="client-db-wms-get-box-quantity" doc:id="0c31bbcd-70e6-4f4a-8546-188b92a19c4a" >
		<db:select doc:name="Select" doc:id="99247b82-ec6d-40d6-9f8d-c8134d005366" config-ref="Database_Config_WMS_BlueYonder">
			<db:sql ><![CDATA[select (select sum(case when (invd_h1.subnum like 'SHP%' or invd_h1.subnum like 'CTN%') then 1
                         else ceil(sum(invd_h1.untqty) / (select distinct dtl_cas.untcas
                                                            from TRXWMSPRD.invdtl_hist dtl_cas
                                                           where dtl_cas.subnum = invd_h1.subnum))
                    end)
           from TRXWMSPRD.shipment_line shplin
           join TRXWMSPRD.invdtl_hist invd_h1
             on invd_h1.ship_line_id = shplin.ship_line_id
           join TRXWMSPRD.invsub_hist invs_h1
             on invs_h1.subnum = invd_h1.subnum
          where shplin.ship_id = shipment_line.ship_id
            and invs_h1.lodnum = invsub_hist.lodnum
            and shplin.wh_id = invlod_hist.wh_id
          group by invd_h1.subnum) as bultos_por_orden,
        shipment_line.ship_id,
        ord.ordnum
   from TRXWMSPRD.shipment_line
   join TRXWMSPRD.ord
     on ord.client_id = shipment_line.client_id
    and ord.ordnum = shipment_line.ordnum
    and ord.wh_id = shipment_line.wh_id
   join TRXWMSPRD.invdtl_hist
     on invdtl_hist.ship_line_id = shipment_line.ship_line_id
   join TRXWMSPRD.invsub_hist
     on invsub_hist.subnum = invdtl_hist.subnum
   join TRXWMSPRD.invlod_hist
     on invlod_hist.lodnum = invsub_hist.lodnum
  where shipment_line.ship_id in ('SID0002322')
    and shipment_line.wh_id = 'AVIOR-27'
  group by shipment_line.ship_id,
        invsub_hist.lodnum,
        ord.ordnum,
        invdtl_hist.subnum,
        invlod_hist.wh_id
]]></db:sql>
			<db:input-parameters ><![CDATA[#[shipment:payload]]]></db:input-parameters>
		</db:select>
	</sub-flow>
	<sub-flow name="client-db-wms-get-logistics-footprint" doc:id="1dea7a51-4674-4ad4-8e38-ff198bf66e3b" >
		<db:select doc:name="Select" doc:id="4754006c-1203-46c8-8718-c781618ad286" config-ref="Database_Config_WMS_BlueYonder">
			<db:sql ><![CDATA[#[vars.queryLogisticFootprint]]]></db:sql>
		</db:select>
	</sub-flow>
	<sub-flow name="client-db-wms-get-box" doc:id="0c31bbcd-70e6-4f4a-8546-188b92a19c4a" >
		<db:select doc:name="Select" doc:id="f795c9d5-854c-424f-9313-820d5f45f012" config-ref="Database_Config_WMS_BlueYonder" >
			<db:sql ><![CDATA[select *
from
(select count(distinct pv2.ctnnum) as "SurtidosEnPalet", 
        max(iv.lodnum) LPN
from TRXWMSPRD.pckwrk_view pv1
join TRXWMSPRD.pckwrk_view pv2
on pv1.schbat = pv2.schbat
        and pv1.ordnum = pv2.ordnum
        and pv1.ordlin = pv2.ordlin
        and pv1.ordsln = pv2.ordsln
        and pv1.subnum = pv2.ctnnum
join TRXWMSPRD.inventory_view iv
on pv2.wrkref = iv.wrkref
        and pv2.wrkref_dtl = iv.wrkref_dtl
        and pv2.ship_line_id = iv.ship_line_id
        and pv2.ctnnum = iv.subnum
        and pv2.wh_id = iv.wh_id
        and pv2.prt_client_id = iv.prt_client_id
        and pv2.prtnum = iv.prtnum
JOIN TRXWMSPRD.locmst lm
on iv.wh_id = lm.wh_id
        and iv.stoloc = lm.stoloc
where pv1.ordnum = :ordnum
        and pv1.wrktyp = 'K'
        and pv1.appqty = 1
        and lm.mov_zone_id = '10036') inPal,
(select count(distinct pv2.ctnnum) as "Surtidos"
from TRXWMSPRD.pckwrk_view pv1
join TRXWMSPRD.pckwrk_view pv2
on pv1.schbat = pv2.schbat
        and pv1.ordnum = pv2.ordnum
        and pv1.ordlin = pv2.ordlin
        and pv1.ordsln = pv2.ordsln
        and pv1.subnum = pv2.ctnnum
join TRXWMSPRD.inventory_view iv
on pv2.wrkref = iv.wrkref
        and pv2.wrkref_dtl = iv.wrkref_dtl
        and pv2.ship_line_id = iv.ship_line_id
        and pv2.ctnnum = iv.subnum
        and pv2.wh_id = iv.wh_id
        and pv2.prt_client_id = iv.prt_client_id
        and pv2.prtnum = iv.prtnum
JOIN TRXWMSPRD.locmst lm
on iv.wh_id = lm.wh_id
        and iv.stoloc = lm.stoloc
where pv1.ordnum = :ordnum
        and pv1.wrktyp = 'K'
        and pv1.appqty = 1
        and lm.mov_zone_id != '10036') inPal2,
(select count(*) "SinSurtir"
   from TRXWMSPRD.pckwrk_view
  where ordnum = :ordnum
    and wrktyp = 'K'
    and appqty = 0) "Mis"]]></db:sql>
			<db:input-parameters ><![CDATA[#[ordnum: payload]]]></db:input-parameters>
		</db:select>
	</sub-flow>
	<sub-flow name="client-db-wms-get-lpn" doc:id="5aeb1db0-6d8d-472e-ad4a-678eca027890" >
		<db:select doc:name="Select" doc:id="b95dd3ad-9484-442b-80d8-c93b9575a296" config-ref="Database_Config_WMS_BlueYonder" >
			<db:sql ><![CDATA[select * from
(select count(distinct pv2.ctnnum) "SurtidosEnPalet"
   from TRXWMSPRD.pckwrk_view pv1
   join TRXWMSPRD.pckwrk_view pv2
     on pv1.schbat = pv2.schbat
    and pv1.ordnum = pv2.ordnum
    and pv1.ordlin = pv2.ordlin
    and pv1.ordsln = pv2.ordsln
    and pv1.subnum = pv2.ctnnum
   join TRXWMSPRD.inventory_view iv
     on pv2.wrkref = iv.wrkref
    and pv2.wrkref_dtl = iv.wrkref_dtl
    and pv2.ship_line_id = iv.ship_line_id
    and pv2.ctnnum = iv.subnum
    and pv2.wh_id = iv.wh_id
    and pv2.prt_client_id = iv.prt_client_id
    and pv2.prtnum = iv.prtnum
   JOIN TRXWMSPRD.locmst lm
     on iv.wh_id = lm.wh_id
    and iv.stoloc = lm.stoloc
  where IV.lodnum = :lodnum
    and pv1.wrktyp = 'K'
    and pv1.appqty = 1) a,
(select count(*) SinSurtir
   from TRXWMSPRD.pckwrk_view pv
   join TRXWMSPRD.inventory_pckwrk_view ipv
     on pv.ordnum = ipv.ordnum
    and ipv.lodnum != pv.lodnum
  where pv.wrktyp = 'K'
    and pv.appqty = 0
    and ipv.lodnum = :lodnum) b,
(select count(distinct ipv2.ctnnum) Surtidos
   from TRXWMSPRD.inventory_pckwrk_view ipv2
   join TRXWMSPRD.locmst
     on ipv2.stoloc = locmst.stoloc
    and ipv2.wh_id = locmst.wh_id
    and locmst.mov_zone_id != '10036'
    /*and ipv.lodnum != ipv2.lodnum*/
  where ipv2.wrktyp = 'P'
    and ipv2.lodnum = :lodnum) c]]></db:sql>
			<db:input-parameters ><![CDATA[#[lodnum: payload]]]></db:input-parameters>
		</db:select>
	</sub-flow>
	<sub-flow name="client-db-wms-get-download-sequence" doc:id="15cef186-5c0b-4b19-bd30-fd34144e7faa" >
		<db:select doc:name="Select" doc:id="b72ccc08-b40d-464d-a750-8a93706f1e62" config-ref="Database_Config_WMS_BlueYonder" >
			<db:sql ><![CDATA[select distinct TRXWMSPRD.sl_dwnld.*
   from TRXWMSPRD.sl_ifd_data_dtl
   join TRXWMSPRD.sl_ifd_data_hdr
     on TRXWMSPRD.sl_ifd_data_hdr.ifd_data_seq = sl_ifd_data_dtl.ifd_data_seq
   join TRXWMSPRD.sl_dwnld
     on TRXWMSPRD.sl_dwnld.dwnld_seq = sl_ifd_data_hdr.dwnld_seq
  where TRXWMSPRD.sl_dwnld.DWNLD_SEQ like :downloadSequence]]></db:sql>
			<db:input-parameters ><![CDATA[#[downloadSequence: "%" ++ payload ++ "%"]]]></db:input-parameters>
		</db:select>
	</sub-flow>
	<sub-flow name="client-db-wms-daily-balance-sp" doc:id="65b13491-4f77-497b-8efe-62dd55b9ff04" >
		<db:stored-procedure doc:name="Stored procedure" doc:id="908312f3-8c40-4271-9e46-d4e16dd6b4cd" config-ref="Database_Config_WMS_BlueYonder">
			<db:sql ><![CDATA[{ call DAILY_INVENTORY_UPDATE }]]></db:sql>
		</db:stored-procedure>
	</sub-flow>
</mule>
