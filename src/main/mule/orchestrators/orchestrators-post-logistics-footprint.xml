<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<sub-flow name="orchestrators-logistics-footprint" doc:id="9de8a181-03dc-4282-8646-dec20083d7c8" >
<!-- [STUDIO:"Payload"]		<logger level="INFO" doc:name="Payload" doc:id="4153579e-e855-471f-bd59-07630cedd630" message="payloadXML: #[payload] " /> [STUDIO] -->
		<logger level="INFO" doc:name="Logger" doc:id="2c515e12-a035-4d9b-a71a-fc56e54663df" message="footprint - #[attributes.queryParams.customer_name]" />
		<ee:transform doc:name="get Skus" doc:id="c7a34687-61f3-4324-b958-cd1dcfbd1680">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
"'" ++((payload.skus) joinBy "," ) replace "," with("','") ++ "'"]]></ee:set-payload>
			</ee:message>
			<ee:variables>
				<ee:set-variable variableName="arrayAux"><![CDATA[%dw 2.0
output application/json
---
[]]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<ee:transform doc:name="Set Query" doc:id="61f4c640-70fc-4df6-9334-8bb6e5273615">
			<ee:message />
			<ee:variables>
				<ee:set-variable variableName="query"><![CDATA[%dw 2.0
import modules::pharma
output application/json
var schema = pharma::getSchema(attributes.queryParams.customer_name, p('database.wms.blueyonder.schema'),p('database.wms.mega.schema'))
var avior = pharma::getAvior(attributes.queryParams.customer_name, p('database.wms.blueyonder.avior'), p('database.wms.mega.avior'))
---
"SELECT 
    iv.uomcod,/*Pallets, Pieza, Caja, */
    iv.prtnum, /*codigo producto*/
    iv.ftpcod, /*codigo huella logistica*/
    iv.untqty,
    iv.len,
    iv.wid,
    iv.hgt,
    iv.grswgt,
    iv.netwgt,
    pftpc.defftp_flg,
    pftpc.caslvl,
    iv.len * iv.wid * iv.hgt vol
FROM "++ schema ++".prtftp_dtl iv,
    (SELECT p.ftpcod, p.caslvl, p.defftp_flg FROM "++ schema ++".prtftp p  WHERE  p.wh_id = 'AVIOR-27') pftpc
WHERE iv.ftpcod = pftpc.ftpcod
    AND iv.ftpcod IN ( " ++ payload ++ ") and
	iv.wh_id='" ++ avior ++ "'"
]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<logger level="INFO" doc:name="Logger" doc:id="54629675-be92-432a-a237-6b0979fb93cf" message="#[vars.query]" />
		<flow-ref doc:name="client-get-availability-db-get-logistics-footprint" doc:id="3eb7322e-8a5b-41de-b92d-80d410b110b8" name="common-pharma-selectSub_Flow"/>
		<set-payload value="#[%dw 2.0&#10;output application/json&#10;---&#10;payload]" doc:name="to Json" doc:id="25d92b1d-53c1-4ae1-bd5a-41c9cd363b5f" />
		<!-- [STUDIO:"Response"]		<logger level="INFO" doc:name="Response" doc:id="30ca8b17-36de-42c8-800e-d90959eae24f" message="Response XML: #[payload]" /> [STUDIO] -->
	</sub-flow>
</mule>
